====================================================================================
CSEE W4119 Computer Networks
Programming Assignment 1 
Lina Jin
UNI: lj2351
====================================================================================
1. Programming Design
   This Programming project includes two major modules, one is server, which is also known as Message Center, the other one is Client. 
   As for the Message Center, there are two main threads. One is listen to the socket and handle the incoming messages from Client. The other one is to check the heartbeat to determine if the user is disconnected. 
   As for the Client, there are also three threads. StreamThread is used to read user input from keyboard, handle the messages and send to the server. ListenThread is used for listening to the incoming messages from both server and p2p clients. The third thread is used for generate heartbeat every 30 seconds. 
   
2. Server
1) Data Structure
   a) socketUser: HashMap<String,String>
      Key: usernames of users who are currently online
      Value: Socket information of each user, including IP address and Port Number
   b) block_list: HashMap<String,Long>
      Key: users who failed to login for three times
      Value: the time of last login attempt
   c) TagUser: HashMap<String, String>
      Key: identifier of each user, which is generated by uuid
      Value: username
   d) UserTag: HashMap<String, String>
      Key: username
      Value: identifier of each user
   e) listen_id: HashMap<String, Integer>
      Key: identifier of each user
      Value: the listening port of each user
   f) heartbeat: HashMap<String, Long>
      Key: user identifier
      Value: last time when server receives a message from user
   g) whiteList: HashMap<String, HashSet<String>>
      Key: username
      Value: list of users that key user doesn't block
   h) offMsg: HashMap<String, ArrayList<String>>
      Key: username
      Value: list of messages that sent to the user when the user is offline
2) Class ConnectionThread
   Once the listening server socket of the server accept a Socket from client, a new ConnectionThread is created. Methods of Class ConnectionThread:
   1. public int readCredentials(String name_pwd) 
      When client sent a login request to the server, readCredentials(String name_pwd) is called to check the credentials. 
      ###Please place the credentials file in the same directory with source code###

   2. public void run()
      Each time when server receives a message from client, it reads the header of this message and then doing its job accordingly.
      =========USERNAME=========
      Server will firstly check if the block_list contains the username, if it does, server sent "3" to the client to remind the user of trying to login again later.
      If the user is not in the block_list, then we call readCredentials() method to check the authentication. If the user failed to enter the correct password and username for 3 times, the server will put the user into the black_list.
      Once the user login successfully, the server will generate a uuid for this user as an identifier, and this identifier would send back to the client. For the later message exchange, the client will attach this uuid as a header in the message sent to the server.Also, the server will record the listening port of the client for the purpose of non-permanent 
      =========message=========
      when the server receives a message exchange request, it firstly check if sender is in the whiteList of receiver, if not, the massage exchange request failed. Otherwise, message sent to the receiver no matter the receiver is online or offline.
      ====block and unblock=====
      While receiving a message with header "block" or "unblock", the server will update the whiteList of this user accordingly.
      ========broadcast=========
      Server will broadcast the message to all the users that in the whiteList of the sender.
      ==========online==========
      Printout all the users that currently online, that is print the key in socketUser to the user.
      ========getaddress========
      The serve would firstly check if the user is online. If the user is offline, it send "Request Failure". If the user is online, the server then check is the user made this request is on the whiteList of this user. If yes, then the socket information would sent back. Otherwise, it notifies the request that the socket information is not reachable.
      ==========logout==========
      Once the server receives a logout request from user. It sent "logout" message back to the client. Then the client side would exist the system and the serve would update all the data structures.

   3. public void newConnection(String msg, String rcv)
      This method is for the non-permanent message sending from server to client. A socket with a ip address and a listening port number of the receiver is created and once the message is sent to the client, this socket will close.

   4. private void offlineMessage(String recipient, String msg)
      Once the server found out that the message receiver is offline, it stores the message in the offMsg. 

   5. private void logoutExistingUser(String username)
      While a user is online, if someone uses the same username/password to log in from another IP, current user will be notified and automatically logged out.

   6. private void sendOfflineMsg() 
      Every time when a user logs in successfully, we call sendOfflineMsg() to see if this user has offline messages, if yes, then offline message is sent to the user.

   7. public void onlineReport(String user)
      A broadcast message to all users when a user is online.

   8. public void offlineReport(String user)
      A broadcast message to all users when a user is offline.

3) Class checkHeartBeat
   Every time when the server receives a message from client, HashMap heartbeat update the related value to record the latest time. Thread checkHeartBeat checks the data structure heartbeat every 35 seconds using the current time to check timeout. 
====================================================================================
3. Client
1) Data Structure
   p2pSocket: HashMap<String, String>
2) public static boolean isPortUsing(int port)
   check if the randomly generated listening port is in use or not
3) Class streamThread
   During the login process, when the client receives 
   "0": it prints "Welcome to simple chat server!";
   "1": "Invalid Password. Please try again"
   "2": "Invalid Password. Your account has been blocked. Please try again after sometime"
   "3": "Due to multiple login failures, your account has been blocked. Please try again after sometime."
   After successfully logging in, the client will sent the listening port to the server, so that server can send message to the client during the non-permanent transmission. When receives a message from user, the client will check if the user wants to start a p2p connection with a message starts with "private". If yes, then the client will check the listen_id to look for the socket information of the receiver and create a socket, after sending the message, the socket closes due to the non-permanent request. If the socket information is not available, then the client will print "Please use getaddress <user> command to start P2P connection." to user. Also, if the socket information is invalid, then the client will ask the user to send offline message through the server.
   If the user doesn't initialize a p2pconnection, the client creates a socket, attaches the uuid to the message as a header, and send to the server. Then this socket is closed for the non-permanent transmission.
4) Class listenThread
   This thread handles messages send to the client from server and p2p clients. This thread checks the header of messages.
   "logout": system exists; 
   "EXISTING": print "You have logged out since other people have logged in using the same USERNAME" and exists.
   "P2P": put the socket information in the listen_id data structure.
   "private": print out the p2p message.
   OTHERS: print out the receiving message. Since the message is already handled in server side.
====================================================================================  
4. Commands
=====message <user> <message>=====
Send <message> to <user> if the sender is not blocked by the <user>. Offline message is saved in case of <user> is offline.
====broadcast <message>=====
Broadcast messages to all users online. It also considers the block scenario.
========online========
List all the users online.
=====block <user>=====
Don't receive messages from <user> and server wouldn't send socket information to the <user> for p2p connection.
====unblock <user>====
Unblock the <user>.
========logout========
Logout the chat room and a logout message is sent to all users online.
===getaddress <user>===
Get the IP and Port information of the user for the later p2p connection.
====private <user> <message>====
Make sure to execute getaddress <user> before using this command to send p2p messages.
====================================================================================
5. Run the Program
>make
To run the server: 
>java Server <PORT>
To run the client:
>java Client <Server IP> <PORT>
====================================================================================
6. Additional Features
P2P Privacy and Consent
When A requests for B’s IP address, the message centre should check B’s blacklist preferences. If B’s blacklist includes A, the message centre should not provide B’s IP address to A.
